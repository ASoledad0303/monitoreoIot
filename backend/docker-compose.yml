version: "3.9"

services:
  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    ports:
      - "8086:8086"
    environment:
      DOCKER_INFLUXDB_INIT_MODE: ${DOCKER_INFLUXDB_INIT_MODE}
      DOCKER_INFLUXDB_INIT_USERNAME: ${DOCKER_INFLUXDB_INIT_USERNAME}
      DOCKER_INFLUXDB_INIT_PASSWORD: ${DOCKER_INFLUXDB_INIT_PASSWORD}
      DOCKER_INFLUXDB_INIT_ORG: ${DOCKER_INFLUXDB_INIT_ORG}
      DOCKER_INFLUXDB_INIT_BUCKET: ${DOCKER_INFLUXDB_INIT_BUCKET}
      DOCKER_INFLUXDB_INIT_RETENTION: ${DOCKER_INFLUXDB_INIT_RETENTION}
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: ${DOCKER_INFLUXDB_INIT_ADMIN_TOKEN}
      INFLUXD_HTTP_BIND_ADDRESS: :8086
    volumes:
      - influxdb2-data:/var/lib/influxdb2
      - influxdb2-config:/etc/influxdb2
    # healthcheck:
    #   test: ["CMD-SHELL", "influx ping --host-url http://127.0.0.1:8086 >/dev/null 2>&1 || exit 1"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 60
    #   start_period: 120s
    # restart: unless-stopped



  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mosquitto
    ports:
      - "1883:1883"
    entrypoint: [ "sh", "-c", "echo 'listener 1883\nallow_anonymous true' > /mosquitto-no-auth.conf && exec mosquitto -c /mosquitto-no-auth.conf" ]
    restart: unless-stopped

  telegraf:
    build:
      context: ./telegraf
      dockerfile: Dockerfile
    container_name: telegraf
    depends_on:
      # influxdb:
        # condition: service_healthy
      mosquitto:
        condition: service_started
    volumes:
      - ./telegraf:/etc/telegraf:ro
    environment:
      INFLUXDB_URL: ${INFLUXDB_URL}
      INFLUXDB_TOKEN: ${INFLUXDB_TOKEN}
      INFLUXDB_ORG: ${INFLUXDB_ORG}
      INFLUXDB_BUCKET: ${INFLUXDB_BUCKET}
      # PostgreSQL - usar DATABASE_URL o variables individuales
      # Ajusta localhost a host.docker.internal para que funcione desde Docker
      # Si tienes: postgres://postgres:a.123456@localhost:5432/tesis_iot_db
      # Usa: postgresql://postgres:a.123456@host.docker.internal:5432/tesis_iot_db
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:a.123456@host.docker.internal:5432/tesis_iot_db}
      # O usar variables individuales
      POSTGRES_HOST: ${POSTGRES_HOST:-host.docker.internal}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_DB: ${POSTGRES_DB:-tesis_iot_db}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-a.123456}
    # Para Linux, usar network_mode: "host" o agregar extra_hosts
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  emulator:
    image: python:3.11-alpine
    container_name: esp-emulator
    depends_on:
      mosquitto:
        condition: service_started
    command: ["sh", "-c", "pip install --no-cache-dir paho-mqtt && python /app/emulator.py"]
    environment:
      MQTT_BROKER: mosquitto
      MQTT_PORT: 1883
      MQTT_BASE: ${MQTT_BASE:-tesis/iot/esp32}
    volumes:
      - ./emulator.py:/app/emulator.py:ro
    restart: unless-stopped

  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: iot-api
    depends_on:
      mosquitto:
        condition: service_started
      # influxdb:
        # condition: service_healthy
    environment:
      # API (Flask)
      PORT: ${API_PORT:-5000}
      FLASK_ENV: production

      # MQTT para lectura en tiempo real
      MQTT_BROKER: mosquitto
      MQTT_PORT: 1883
      MQTT_BASE: ${MQTT_BASE:-tesis/iot/esp32}
      # MQTT_USER: ${MQTT_USER}
      # MQTT_PASS: ${MQTT_PASS}

      # (Opcional) InfluxDB si luego querés consultas históricas desde la API
      INFLUXDB_URL: ${INFLUXDB_URL}
      INFLUXDB_TOKEN: ${INFLUXDB_TOKEN}
      INFLUXDB_ORG: ${INFLUXDB_ORG}
      INFLUXDB_BUCKET: ${INFLUXDB_BUCKET}

      # PostgreSQL para consultas históricas (>30 días)
      # Usar mypostgres si está en la misma red, sino host.docker.internal
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:${POSTGRES_PASSWORD:-a.123456}@mypostgres:5432/tesis_iot_db}
      POSTGRES_HOST: ${POSTGRES_HOST:-mypostgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_DB: ${POSTGRES_DB:-tesis_iot_db}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-a.123456}

      # Buffer de muestras
      SAMPLES_BUFFER_SIZE: 2000
    ports:
      - "${API_PORT:-5000}:5000"
    restart: unless-stopped

volumes:
  influxdb2-data:
  influxdb2-config:
